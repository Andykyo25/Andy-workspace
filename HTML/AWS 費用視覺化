<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS è²»ç”¨è¦–è¦ºåŒ– (V12 æ™ºèƒ½è¨ºæ–·ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif; background-color: #f8fafc; }
        
        .bg-gradient-brand { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); }
        
        .card { 
            background: white; 
            border-radius: 16px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(226, 232, 240, 0.8);
            transition: all 0.3s ease;
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        .drag-area { border: 2px dashed #a78bfa; background-color: #f5f3ff; transition: all 0.2s; }
        .drag-area:hover, .drag-area.active { border-color: #7c3aed; background-color: #ede9fe; transform: scale(1.01); }

        .trend-up { color: #f43f5e; font-weight: 700; background: #fff1f2; padding: 2px 6px; border-radius: 4px; }
        .trend-down { color: #10b981; font-weight: 700; background: #ecfdf5; padding: 2px 6px; border-radius: 4px; }
        
        /* æœˆä»½ç¯©é¸æŒ‰éˆ•æ¨£å¼ */
        .month-btn { transition: all 0.2s; border: 1px solid #e2e8f0; }
        .month-btn:hover { background-color: #f1f5f9; }
        .month-btn.active { background-color: #6366f1; color: white; border-color: #6366f1; box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3); }

        /* å»ºè­°å¡ç‰‡å‹•ç•« */
        @keyframes slideIn { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }
        .insight-item { animation: slideIn 0.3s ease-out forwards; }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c4b5fd; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a78bfa; }
    </style>
    <script id="preloaded-data">window.PRELOADED_DATA = null;</script>
</head>
<body class="text-slate-700 h-screen flex flex-col overflow-hidden">

    <!-- é ‚éƒ¨å°èˆª -->
    <div class="bg-white/90 backdrop-blur-md border-b border-indigo-100 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3 flex flex-col md:flex-row items-center justify-between gap-4">
            
            <div class="flex items-center gap-3 w-full md:w-auto">
                <div class="bg-gradient-brand text-white p-2.5 rounded-xl shadow-lg shadow-indigo-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-slate-800 tracking-tight">AWS è²»ç”¨è¦–è¦ºåŒ– <span class="text-xs bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded-full ml-1">V12</span></h1>
                    <p class="text-xs text-slate-500 font-medium">âœ¨ æ™ºèƒ½è¨ºæ–· â€¢ è‡ªå‹•åˆ†æå¸³å–®ç•°å¸¸</p>
                </div>
            </div>

            <div class="flex flex-wrap items-center gap-3 w-full md:w-auto justify-end" id="control-panel">
                <button onclick="exportReport()" class="h-10 px-4 bg-slate-800 hover:bg-slate-900 text-white rounded-xl text-sm font-bold shadow-md transition flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4-4m0 0l-4 4m4-4v12"></path></svg>
                    åŒ¯å‡ºå”¯è®€å ±è¡¨
                </button>
                <button onclick="clearAllData()" class="h-10 px-3 border border-red-200 text-red-500 hover:bg-red-50 rounded-xl text-xs font-bold transition">æ¸…é™¤</button>
                <div class="w-px h-8 bg-slate-300 mx-1"></div>
                <div class="flex items-center gap-2 text-xs font-medium text-slate-500 bg-slate-50 px-3 py-2 rounded-lg border border-slate-200">
                    <input type="checkbox" id="use-big5" class="rounded text-indigo-600 focus:ring-indigo-500 cursor-pointer">
                    <label for="use-big5" class="cursor-pointer">Excel (Big5)</label>
                </div>
                <div id="drop-zone" class="drag-area relative w-full md:w-48 h-10 rounded-xl flex items-center justify-center cursor-pointer group">
                    <input type="file" id="fileInput" accept=".csv" multiple class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                    <div class="flex items-center gap-2 text-sm font-bold text-indigo-500 group-hover:text-indigo-700 transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                        <span>åŒ¯å…¥ CSV</span>
                    </div>
                </div>
                <button onclick="document.getElementById('manual-panel').classList.toggle('hidden')" class="h-10 px-4 bg-gradient-to-r from-orange-400 to-pink-500 hover:from-orange-500 hover:to-pink-600 text-white rounded-xl text-sm font-bold shadow-md transition transform hover:scale-105">+ æ‰‹å‹•</button>
            </div>
        </div>
        
        <div id="manual-panel" class="hidden bg-slate-50 border-b border-indigo-100 p-4 animate-fade-in">
            <div class="max-w-7xl mx-auto flex flex-wrap items-center gap-3">
                <span class="text-xs font-bold bg-slate-200 text-slate-600 px-2 py-1 rounded">æ‰‹å‹•è¼¸å…¥</span>
                <input type="month" id="man-month" class="px-3 py-1.5 border border-slate-300 rounded-lg text-sm focus:outline-none focus:border-indigo-500">
                <input type="number" id="man-mix" placeholder="MIX é‡‘é¡" class="px-3 py-1.5 border border-slate-300 rounded-lg text-sm w-32">
                <input type="number" id="man-prd" placeholder="PRD é‡‘é¡" class="px-3 py-1.5 border border-slate-300 rounded-lg text-sm w-32">
                <button onclick="addManualData()" class="px-4 py-1.5 bg-indigo-600 text-white text-sm rounded-lg font-bold hover:bg-indigo-700 shadow">ç¢ºèªæ–°å¢</button>
            </div>
        </div>
    </div>

    <!-- ä¸»å…§å®¹å€ -->
    <div class="flex-1 overflow-y-auto p-4 md:p-6 bg-slate-50/50">
        <div class="max-w-7xl mx-auto space-y-8 pb-10">

            <div id="empty-state" class="flex flex-col items-center justify-center py-24 text-center">
                <div class="w-24 h-24 bg-white rounded-full shadow-xl flex items-center justify-center mb-6 animate-bounce">
                    <span class="text-5xl">ğŸ¤–</span>
                </div>
                <h2 class="text-3xl font-bold text-slate-800 mb-2">è³‡æ–™è¼‰å…¥èˆ‡æ™ºèƒ½è¨ºæ–·</h2>
                <p class="text-slate-500 max-w-md mx-auto">ç³»çµ±å°‡è‡ªå‹•åˆ†æåŒ¯å…¥çš„å¸³å–®ï¼Œæ‰¾å‡ºæ½›åœ¨çš„ç¯€è²»æ©Ÿæœƒèˆ‡ç•°å¸¸é …ç›®ã€‚</p>
            </div>

            <div id="dashboard" class="hidden space-y-8 animate-fade-in-up">
                
                <!-- KPI Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-5">
                    <div class="card p-6 relative overflow-hidden group">
                        <div class="absolute -right-4 -top-4 w-24 h-24 bg-indigo-50 rounded-full group-hover:scale-110 transition duration-500"></div>
                        <p class="text-xs font-bold text-indigo-500 uppercase tracking-wider relative z-10">å¹´åº¦ç¸½æ”¯å‡º</p>
                        <h3 class="text-3xl font-bold text-slate-800 mt-2 relative z-10" id="kpi-total">-</h3>
                        <div class="mt-2 text-xs text-slate-400 relative z-10">Total Cost (NTD)</div>
                    </div>
                    <div class="card p-6 relative overflow-hidden group">
                        <div class="absolute -right-4 -top-4 w-24 h-24 bg-purple-50 rounded-full group-hover:scale-110 transition duration-500"></div>
                        <p class="text-xs font-bold text-purple-500 uppercase tracking-wider relative z-10">PRD ç’°å¢ƒä½”æ¯”</p>
                        <h3 class="text-3xl font-bold text-slate-800 mt-2 relative z-10" id="kpi-ratio">-</h3>
                        <div class="mt-2 text-xs text-slate-400 relative z-10">Production Usage</div>
                    </div>
                    <div class="card p-6 relative overflow-hidden group">
                        <div class="absolute -right-4 -top-4 w-24 h-24 bg-pink-50 rounded-full group-hover:scale-110 transition duration-500"></div>
                        <p class="text-xs font-bold text-pink-500 uppercase tracking-wider relative z-10">æœ€è²´æœå‹™</p>
                        <h3 class="text-2xl font-bold text-slate-800 mt-2 truncate relative z-10" id="kpi-top-svc">-</h3>
                        <div class="mt-2 text-xs text-slate-400 relative z-10">Highest Spend Service</div>
                    </div>
                    <div class="card p-6 relative overflow-hidden group">
                        <div class="absolute -right-4 -top-4 w-24 h-24 bg-orange-50 rounded-full group-hover:scale-110 transition duration-500"></div>
                        <p class="text-xs font-bold text-orange-500 uppercase tracking-wider relative z-10">æœ€é«˜æœˆè²»</p>
                        <h3 class="text-2xl font-bold text-slate-800 mt-2 relative z-10" id="kpi-max-month">-</h3>
                        <div class="mt-2 text-xs text-slate-400 relative z-10">Peak Spending Month</div>
                    </div>
                </div>

                <!-- Trend Chart Section with Month Filter -->
                <div class="card p-6">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                        <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                            <span class="text-2xl">ğŸ“ˆ</span> æœˆåº¦è²»ç”¨è¶¨å‹¢
                        </h3>
                        <div id="month-selector" class="flex flex-wrap gap-2"></div>
                    </div>
                    <div class="h-80"><canvas id="trendChart"></canvas></div>
                </div>

                <!-- Deep Dive & Insights -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- Left: Deep Dive Chart (2/3) -->
                    <div class="lg:col-span-2 bg-gradient-to-br from-white to-indigo-50 rounded-2xl border border-indigo-100 p-6 shadow-sm">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                            <div>
                                <h3 class="text-lg font-bold text-slate-700 flex items-center gap-2">ğŸ” æ·±åº¦æŒ–æ˜</h3>
                                <p class="text-xs text-slate-400 mt-1">è¿½è¹¤ç‰¹å®šæœå‹™æˆ–é—œéµå­—</p>
                            </div>
                            <div class="flex flex-wrap gap-2 bg-white/80 backdrop-blur p-1.5 rounded-lg border border-indigo-100 shadow-sm">
                                <select id="dd-service" class="text-xs bg-transparent border-none focus:ring-0 font-bold text-slate-600 outline-none" onchange="updateDeepDive()"><option value="ALL">å…¨éƒ¨æœå‹™</option></select>
                                <div class="w-px h-5 bg-slate-200"></div>
                                <input type="text" id="dd-keyword" placeholder="é—œéµå­—..." class="text-xs bg-transparent border-none focus:ring-0 w-24 outline-none" oninput="updateDeepDive()">
                                <div class="w-px h-5 bg-slate-200"></div>
                                <label class="flex items-center gap-1 cursor-pointer select-none px-2"><input type="checkbox" id="dd-smooth" class="rounded text-indigo-600 focus:ring-0" checked onchange="updateDeepDive()"><span class="text-xs font-bold text-indigo-600">é€£ç·š</span></label>
                            </div>
                        </div>
                        <div class="h-64"><canvas id="deepDiveChart"></canvas></div>
                    </div>

                    <!-- Right: Dynamic Insights (1/3) -->
                    <div class="card p-5 border-l-4 border-yellow-400 flex flex-col">
                        <div class="flex items-center gap-2 mb-4">
                            <span class="text-xl">ğŸ¤–</span>
                            <h3 class="text-lg font-bold text-slate-800">æ™ºèƒ½è²»ç”¨è¨ºæ–·</h3>
                        </div>
                        <!-- Dynamic Insights Container -->
                        <div id="insights-container" class="space-y-3 overflow-y-auto max-h-72 custom-scrollbar">
                            <!-- JSå°‡æœƒè‡ªå‹•ç”Ÿæˆå…§å®¹ -->
                            <div class="text-center text-xs text-slate-400 py-4">æ­£åœ¨åˆ†æå¸³å–®æ•¸æ“š...</div>
                        </div>
                    </div>
                </div>

                <!-- Table -->
                <div class="card overflow-hidden">
                    <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                        <h3 class="font-bold text-slate-800">ğŸ“‹ æœˆåº¦è©³ç´°å ±è¡¨</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-right whitespace-nowrap">
                            <thead class="bg-slate-100/80 text-slate-500 font-bold uppercase text-[10px] tracking-wider">
                                <tr>
                                    <th class="px-6 py-3 text-left">æœˆä»½</th>
                                    <th class="px-6 py-3">MIX</th>
                                    <th class="px-6 py-3">PRD</th>
                                    <th class="px-6 py-3">MIX å·®ç•°</th>
                                    <th class="px-6 py-3">PRD å·®ç•°</th>
                                    <th class="px-6 py-3 bg-indigo-50 text-indigo-900">ç¸½é‡‘é¡</th>
                                    <th class="px-6 py-3">ç¸½å·®ç•° (MoM)</th>
                                    <th class="px-6 py-3 text-center">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="report-table-body" class="divide-y divide-slate-100 bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="detail-modal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-2xl">
                <div><h3 class="font-bold text-xl text-slate-800">ğŸ“Š <span id="modal-title">åˆ†æ</span></h3></div>
                <button onclick="document.getElementById('detail-modal').classList.add('hidden')" class="w-8 h-8 rounded-full bg-slate-100 hover:bg-red-100 hover:text-red-500 text-slate-400 font-bold text-lg">&times;</button>
            </div>
            <div id="modal-content-area" class="p-6 overflow-y-auto space-y-6"></div>
        </div>
    </div>

<script>
    Chart.defaults.font.family = "'Noto Sans TC', sans-serif";
    Chart.defaults.color = '#94a3b8';
    let yearlyData = {}, allServices = new Set(), charts = {};
    let activeMonths = new Set();

    const fmt = n => new Intl.NumberFormat('zh-TW', { maximumFractionDigits: 0 }).format(n);
    const fmtUSD = n => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(n);
    const fmtDiff = n => (n > 0 ? '+' : '') + fmt(n);
    const getDiffClass = n => n > 100 ? 'trend-up' : (n < -100 ? 'trend-down' : 'text-slate-300 font-bold');

    window.onload = function() {
        if (window.PRELOADED_DATA) {
            yearlyData = window.PRELOADED_DATA;
            document.getElementById('control-panel').innerHTML = '<span class="text-xs font-bold text-indigo-600 bg-indigo-50 px-3 py-2 rounded-lg">å”¯è®€å ±è¡¨æ¨¡å¼</span>';
            rebuildServicesSet(); render();
        } else {
            const cached = localStorage.getItem('aws_dashboard_v12_data');
            if (cached) { try { yearlyData = JSON.parse(cached); rebuildServicesSet(); render(); } catch(e) {} }
        }
    };

    const rebuildServicesSet = () => {
        allServices = new Set();
        Object.values(yearlyData).forEach(m => { [...m.mixI, ...m.prdI].forEach(i => allServices.add(i.s)); });
    };

    const saveData = () => { if (!window.PRELOADED_DATA) localStorage.setItem('aws_dashboard_v12_data', JSON.stringify(yearlyData)); };
    const clearAllData = () => { if(confirm("ç¢ºå®šæ¸…é™¤ï¼Ÿ")) { localStorage.removeItem('aws_dashboard_v12_data'); location.reload(); } };
    
    const exportReport = () => {
        let html = document.documentElement.outerHTML;
        const dataScript = `window.PRELOADED_DATA = ${JSON.stringify(yearlyData)};`;
        const searchStr = 'window.PRELOADED_DATA = null;';
        if (html.includes(searchStr)) {
            html = html.replace(searchStr, dataScript);
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `AWS_Report_${new Date().toISOString().slice(0,10)}.html`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        } else { alert("åŒ¯å‡ºå¤±æ•—"); }
    };

    const handleFiles = async (files) => {
        if (!files.length) return;
        const enc = document.getElementById('use-big5').checked ? 'Big5' : 'UTF-8';
        const promises = Array.from(files).map(f => new Promise(res => {
            Papa.parse(f, { encoding: enc, complete: r => { processFile(f.name, r.data); res(); }, error: res });
        }));
        await Promise.all(promises);
        saveData(); render();
    };

    const findCostValue = (row) => {
        for (let i = row.length - 1; i >= 0; i--) {
            const str = (row[i] || "").toString().trim().replace(/,/g, '');
            if (!str) continue;
            const val = parseFloat(str);
            if (!isNaN(val)) return val;
        }
        return 0;
    };

    const processFile = (fname, rows) => {
        let env='MIX', m=null, tot=0, items=[], currSvc=null;
        for(let i=0; i<Math.min(rows.length,30); i++){
            const s = rows[i].join('||').toUpperCase().replace(/\s/g,'');
            if(s.includes('BILLINGPERIOD')){ const mat=s.match(/(\d{4}-\d{2})/); if(mat) m=mat[1]; }
            if((s.includes('ACCOUNTID')||s.includes('CUSTOMER')) && (s.includes('PRD')||s.includes('PROD'))) env='PRD';
            if(s.includes('TOTALAMOUNTOFPAYMENT') && !s.includes('(USD)')) {
                const nums=rows[i].map(c=>!c?0:parseFloat(c.toString().replace(/,/g,''))).filter(n=>!isNaN(n));
                if(nums.length) tot=Math.max(...nums);
            }
        }
        if(!m){ const mat=fname.match(/(\d{4}-\d{2})/); if(mat) m=mat[1]; }
        if(!m) return;
        rows.forEach(r => {
            const c0 = (r[0]||"").toString().trim();
            const v = findCostValue(r);
            if(c0.startsWith("Amazon") && v > 0) { currSvc = c0; allServices.add(c0); }
            if(currSvc && c0!=="UsageType" && c0 && !c0.includes("Total") && v > 0) items.push({s:currSvc, t:c0, c:v});
        });
        if(!yearlyData[m]) yearlyData[m]={mix:0, prd:0, mixI:[], prdI:[], man:false};
        if(env==='PRD'){ yearlyData[m].prd=tot; yearlyData[m].prdI=items; }
        else{ yearlyData[m].mix=tot; yearlyData[m].mixI=items; }
    };

    const addManualData = () => {
        const m=document.getElementById('man-month').value;
        const mix=parseFloat(document.getElementById('man-mix').value)||0;
        const prd=parseFloat(document.getElementById('man-prd').value)||0;
        if(!m) return alert('è«‹é¸æ“‡æœˆä»½');
        if(!yearlyData[m]) yearlyData[m]={mix:0, prd:0, mixI:[], prdI:[], man:true};
        yearlyData[m].mix=mix; yearlyData[m].prd=prd; yearlyData[m].man=true;
        saveData(); render();
    };

    const toggleMonth = (m) => {
        if (activeMonths.has(m)) activeMonths.delete(m); else activeMonths.add(m);
        render(false);
    };

    const renderMonthSelector = (allMs) => {
        const container = document.getElementById('month-selector'); container.innerHTML = '';
        allMs.forEach(m => {
            const isActive = activeMonths.size === 0 || activeMonths.has(m);
            container.innerHTML += `<button onclick="toggleMonth('${m}')" class="month-btn px-3 py-1 rounded-full text-xs font-bold ${isActive ? 'active' : 'bg-white text-slate-500'}">${m.split('-')[1]}æœˆ</button>`;
        });
    };

    // --- ğŸ¤– æ™ºèƒ½è¨ºæ–·æ ¸å¿ƒé‚è¼¯ (New Feature) ---
    const generateInsights = (displayMs) => {
        const container = document.getElementById('insights-container');
        container.innerHTML = '';
        const insights = [];

        // 1. åµæ¸¬ GP2 (Cost Optimization)
        let foundGP2 = false;
        let gp2Months = [];
        displayMs.forEach(m => {
            const items = [...yearlyData[m].mixI, ...yearlyData[m].prdI];
            if (items.some(i => i.t.toLowerCase().includes('gp2'))) {
                foundGP2 = true; gp2Months.push(m);
            }
        });
        if (foundGP2) {
            insights.push({
                type: 'warn', title: 'ç™¼ç¾èˆŠç‰ˆ GP2 ç¡¬ç¢Ÿ',
                desc: `æª¢æ¸¬åˆ° ${gp2Months.slice(-1)[0]} ç­‰æœˆä»½ä»åœ¨ä½¿ç”¨ GP2 å„²å­˜é¡å‹ã€‚å‡ç´šè‡³ GP3 å¯ç¯€çœç´„ 20% è²»ç”¨ä¸”æ•ˆèƒ½æ›´å¥½ã€‚`
            });
        }

        // 2. MIX ç’°å¢ƒä½”æ¯”éé«˜åµæ¸¬ (Anomaly)
        let highMixMonths = [];
        displayMs.forEach(m => {
            const d = yearlyData[m];
            const total = d.mix + d.prd;
            if (total > 0 && (d.mix / total) > 0.45) { // Threshold: 45%
                highMixMonths.push(m);
            }
        });
        if (highMixMonths.length > 0) {
            insights.push({
                type: 'alert', title: 'MIX æ¸¬è©¦ç’°å¢ƒè²»ç”¨åé«˜',
                desc: `${highMixMonths.slice(-2).join(', ')} çš„æ¸¬è©¦ç’°å¢ƒä½”æ¯”è¶…é 45%ã€‚å»ºè­°æª¢æŸ¥æ˜¯å¦æœ‰é–’ç½®æ©Ÿå™¨æœªé—œæ©Ÿã€‚`
            });
        }

        // 3. æµé‡ç•°å¸¸åµæ¸¬ (Data Transfer)
        let highTransfer = false;
        displayMs.slice(-1).forEach(m => { // åªçœ‹æœ€è¿‘ä¸€å€‹é¸å–çš„æœˆä»½
            const items = [...yearlyData[m].mixI, ...yearlyData[m].prdI];
            const transferCost = items.filter(i => i.s === 'AWSDataTransfer' || i.t.includes('DataTransfer')).reduce((a,b)=>a+b.c, 0);
            const totalCostUSD = items.reduce((a,b)=>a+b.c, 0);
            if (totalCostUSD > 0 && (transferCost / totalCostUSD) > 0.15) { // Threshold: 15%
                highTransfer = true;
            }
        });
        if (highTransfer) {
            insights.push({
                type: 'info', title: 'æµé‡è²»ç”¨ä½”æ¯”é¡¯è‘—',
                desc: 'æœ¬æœŸæµé‡è²»ç”¨è¶…éç¸½æ”¯å‡ºçš„ 15%ã€‚è‹¥å¤šç‚ºå°å¤–æµé‡ï¼Œå»ºè­°è©•ä¼° CloudFront æˆ–æª¢æŸ¥ç•°å¸¸ä¸‹è¼‰ã€‚'
            });
        }

        // 4. å¥åº·åº¦æª¢æŸ¥ (è‹¥ç„¡å•é¡Œ)
        if (insights.length === 0) {
            insights.push({ type: 'good', title: 'è²»ç”¨çµæ§‹å¥åº·', desc: 'ç›®å‰çš„å¸³å–®æ•¸æ“šæœªç™¼ç¾æ˜é¡¯ç•°å¸¸æˆ–éæ™‚é…ç½®ã€‚Keep going!' });
        }

        // Render Insights
        insights.forEach(item => {
            let colorClass = '', icon = '';
            if (item.type === 'warn') { colorClass = 'bg-yellow-50 border-yellow-100 text-yellow-800'; icon = 'âš ï¸'; }
            else if (item.type === 'alert') { colorClass = 'bg-red-50 border-red-100 text-red-800'; icon = 'ğŸš¨'; }
            else if (item.type === 'good') { colorClass = 'bg-green-50 border-green-100 text-green-800'; icon = 'âœ…'; }
            else { colorClass = 'bg-blue-50 border-blue-100 text-blue-800'; icon = 'ğŸ’¡'; }

            container.innerHTML += `
                <div class="insight-item p-3 rounded-lg border ${colorClass}">
                    <h4 class="font-bold text-xs mb-1 flex items-center gap-1.5">${icon} ${item.title}</h4>
                    <p class="text-[11px] opacity-90 leading-relaxed">${item.desc}</p>
                </div>
            `;
        });
    };

    const render = (renderBtns = true) => {
        const allMs = Object.keys(yearlyData).sort();
        if(!allMs.length) return;
        const displayMs = activeMonths.size === 0 ? allMs : allMs.filter(m => activeMonths.has(m));
        if(renderBtns) renderMonthSelector(allMs);

        document.getElementById('empty-state').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');

        const sel = document.getElementById('dd-service');
        if(sel.options.length===1) Array.from(allServices).sort().forEach(s => sel.innerHTML+=`<option value="${s}">${s.replace('Amazon','')}</option>`);

        let gTot=0, pTot=0, maxV=0, maxM='', svcMap={};
        displayMs.forEach(m => {
            const t=yearlyData[m].mix+yearlyData[m].prd; gTot+=t; pTot+=yearlyData[m].prd;
            if(t>maxV){ maxV=t; maxM=m; }
            [...yearlyData[m].mixI, ...yearlyData[m].prdI].forEach(i=>{ svcMap[i.s]=(svcMap[i.s]||0)+i.c; });
        });
        const topSvc = Object.entries(svcMap).sort((a,b)=>b[1]-a[1])[0];

        document.getElementById('kpi-total').innerText = "$"+fmt(gTot);
        document.getElementById('kpi-ratio').innerText = gTot?Math.round((pTot/gTot)*100)+"%":"0%";
        document.getElementById('kpi-max-month').innerText = maxM;
        document.getElementById('kpi-top-svc').innerText = topSvc?topSvc[0].replace('Amazon',''):'-';

        const ctx = document.getElementById('trendChart').getContext('2d');
        if(charts.trend) charts.trend.destroy();
        charts.trend = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: displayMs,
                datasets: [
                    { label: 'MIX', data: displayMs.map(m=>yearlyData[m].mix), backgroundColor: '#a5b4fc', borderRadius:4, stack:'0', order: 2 },
                    { label: 'PRD', data: displayMs.map(m=>yearlyData[m].prd), backgroundColor: '#8b5cf6', borderRadius:4, stack:'0', order: 2 },
                    { 
                        label: 'ç¸½æ”¯å‡º', data: displayMs.map(m=>yearlyData[m].mix+yearlyData[m].prd), type: 'line', 
                        borderColor: '#334155', borderWidth: 3, tension: 0.3, pointBackgroundColor: '#fff', 
                        pointBorderColor: '#334155', pointRadius: 5, fill: false, order: 1,
                        shadowColor: 'rgba(0, 0, 0, 0.3)', shadowBlur: 10, shadowOffsetY: 5
                    }
                ]
            },
            options: { 
                responsive: true, maintainAspectRatio: false,
                plugins: { tooltip: { mode: 'index', intersect: false } }, 
                scales: { x: { grid: { display: false } }, y: { border: { display: false }, grid: { color: '#f1f5f9' }, ticks: { callback: v => fmt(v) }, grace: '10%' } } 
            }
        });

        renderTable(displayMs); 
        updateDeepDive(displayMs);
        generateInsights(displayMs); // Call AI Analysis
    };

    const updateDeepDive = (displayMs) => {
        const allMs = Object.keys(yearlyData).sort();
        const ms = displayMs || (activeMonths.size === 0 ? allMs : allMs.filter(m => activeMonths.has(m)));
        const svc = document.getElementById('dd-service').value;
        const kw = document.getElementById('dd-keyword').value.toUpperCase();
        const smooth = document.getElementById('dd-smooth').checked;

        const data = ms.map(m => {
            const items = [...yearlyData[m].mixI, ...yearlyData[m].prdI];
            if(items.length === 0 && yearlyData[m].man) return smooth ? null : 0;
            const val = items.filter(i => (svc==='ALL'||i.s===svc) && (!kw||i.t.toUpperCase().includes(kw))).reduce((a,b)=>a+b.c, 0);
            return (val === 0 && smooth) ? null : val;
        });

        const ctx = document.getElementById('deepDiveChart').getContext('2d');
        const gradient = ctx.createLinearGradient(0,0,0,300);
        gradient.addColorStop(0, 'rgba(99, 102, 241, 0.5)'); gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');

        if(charts.dd) charts.dd.destroy();
        charts.dd = new Chart(ctx, {
            type: 'line',
            data: { labels: ms, datasets: [{ label: 'è²»ç”¨ (USD)', data: data, borderColor: '#8b5cf6', backgroundColor: gradient, borderWidth: 3, fill: true, tension: 0.4, spanGaps: true, pointBackgroundColor: '#fff' }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x:{grid:{display:false}}, y:{beginAtZero:true, grid:{color:'#f1f5f9'}, ticks:{callback:v=>'$'+v}} } }
        });
    };

    const renderTable = (ms) => {
        const b = document.getElementById('report-table-body'); b.innerHTML = '';
        const allMs = Object.keys(yearlyData).sort();
        ms.forEach((m) => {
            const i = allMs.indexOf(m);
            const d=yearlyData[m], t=d.mix+d.prd;
            let md=0, pd=0, td=0;
            if(i>0){ const p=yearlyData[allMs[i-1]]; md=d.mix-p.mix; pd=d.prd-p.prd; td=t-(p.mix+p.prd); }
            const btn = d.mixI.length+d.prdI.length===0 ? '<span class="text-xs text-slate-300">ç„¡ç´°é …</span>' : `<button onclick="openModal('${m}')" class="px-3 py-1 text-xs font-bold text-indigo-600 bg-indigo-50 hover:bg-indigo-100 rounded-full transition">æŸ¥çœ‹</button>`;
            b.innerHTML += `<tr class="hover:bg-indigo-50/30 transition border-b border-slate-50"><td class="px-6 py-4 font-bold text-left text-slate-700">${m} ${d.man?'<span class="text-[9px] bg-slate-200 text-slate-500 px-1 rounded ml-1">æ‰‹å‹•</span>':''}</td><td class="px-6 py-4 text-slate-500 text-xs">${fmt(d.mix)}</td><td class="px-6 py-4 text-slate-500 text-xs">${fmt(d.prd)}</td><td class="px-6 py-4 text-xs ${getDiffClass(md)}">${i===0?'-':fmtDiff(md)}</td><td class="px-6 py-4 text-xs ${getDiffClass(pd)}">${i===0?'-':fmtDiff(pd)}</td><td class="px-6 py-4 font-bold text-slate-800 text-sm bg-indigo-50/50">${fmt(t)}</td><td class="px-6 py-4 text-xs ${getDiffClass(td)}">${i===0?'-':fmtDiff(td)}</td><td class="px-6 py-4 text-center">${btn}</td></tr>`;
        });
    };

    const openModal = (m) => {
        document.getElementById('detail-modal').classList.remove('hidden'); document.getElementById('modal-title').innerText = `${m} è©³ç´°åˆ†æ`;
        const d = yearlyData[m], all = [...d.mixI.map(i=>({...i,e:'MIX'})), ...d.prdI.map(i=>({...i,e:'PRD'}))];
        const area = document.getElementById('modal-content-area');
        area.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4"><div class="border border-slate-100 rounded-2xl p-4 shadow-sm"><h4 class="text-center text-xs font-bold text-slate-500 mb-2 uppercase">ç’°å¢ƒè²»ç”¨ä½”æ¯”</h4><div class="h-48"><canvas id="modEnv"></canvas></div></div><div class="border border-slate-100 rounded-2xl p-4 shadow-sm"><h4 class="text-center text-xs font-bold text-slate-500 mb-2 uppercase">å‰ 5 å¤§é«˜æˆæœ¬æœå‹™ (USD)</h4><div class="h-48"><canvas id="modSvc"></canvas></div></div></div><div class="bg-slate-50 rounded-xl border border-slate-100 overflow-hidden"><table class="w-full text-xs text-left"><thead class="bg-indigo-50 text-indigo-900 font-bold"><tr><th class="p-3">ç’°å¢ƒ</th><th class="p-3">æœå‹™</th><th class="p-3">ç´°é …</th><th class="p-3 text-right">è²»ç”¨ (USD)</th></tr></thead><tbody class="divide-y divide-slate-100">${all.sort((a,b)=>b.c-a.c).slice(0,10).map(i=>`<tr class="hover:bg-white transition"><td class="p-3"><span class="px-2 py-0.5 rounded-md font-bold text-[10px] ${i.e==='PRD'?'bg-purple-100 text-purple-700':'bg-blue-100 text-blue-700'}">${i.e}</span></td><td class="p-3 font-bold text-slate-700">${i.s.replace('Amazon','')}</td><td class="p-3 text-slate-500 truncate max-w-[200px]" title="${i.t}">${i.t}</td><td class="p-3 text-right font-mono font-bold text-slate-700">${fmtUSD(i.c)}</td></tr>`).join('')}</tbody></table></div>`;
        new Chart(document.getElementById('modEnv'), { type:'doughnut', data:{labels:['MIX','PRD'], datasets:[{data:[d.mix, d.prd], backgroundColor:['#a5b4fc','#7c3aed'], borderWidth:0}]}, options:{cutout:'75%', plugins:{legend:{position:'bottom'}}} });
        const sMap={}; all.forEach(i=>{ sMap[i.s]=(sMap[i.s]||0)+i.c }); const topS=Object.entries(sMap).sort((a,b)=>b[1]-a[1]).slice(0,5);
        new Chart(document.getElementById('modSvc'), { type:'bar', data:{labels:topS.map(s=>s[0].replace('Amazon','')), datasets:[{label:'USD',data:topS.map(s=>s[1]), backgroundColor:'#8b5cf6', borderRadius:4}]}, options:{indexAxis:'y',plugins:{legend:{display:false}},scales:{x:{display:false}}} });
    };

    const dz=document.getElementById('drop-zone'); dz.ondragover=e=>{e.preventDefault();dz.classList.add('active');}; dz.ondragleave=()=>dz.classList.remove('active'); dz.ondrop=e=>{e.preventDefault();dz.classList.remove('active');handleFiles(e.dataTransfer.files);}; document.getElementById('fileInput').onchange=e=>handleFiles(e.target.files);
</script>
</body>
</html>