<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»£è³¼æ˜ç´°çµ±è¨ˆç³»çµ±</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .glass-panel {
            background: rgba(255, 255, 255, 1);
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }
        .form-input { transition: all 0.3s ease; }
        .form-input:focus {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.1);
        }
        .rank-1 { background-color: #fbbf24; color: #fff; }
        .rank-2 { background-color: #94a3b8; color: #fff; }
        .rank-3 { background-color: #b45309; color: #fff; }
        .rank-other { background-color: #f1f5f9; color: #64748b; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="text-slate-600">

<div id="app" class="min-h-screen p-4 md:p-8 max-w-7xl mx-auto">

    <!-- Header & Controls -->
    <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
        <div>
            <h1 class="text-3xl font-bold text-slate-800 tracking-tight">ä»£è³¼æ˜ç´°çµ±è¨ˆç³»çµ±</h1>
            <p class="text-slate-400 text-sm mt-1">æ™ºæ…§åˆ†æèˆ‡åº«å­˜ç®¡ç†</p>
        </div>
        <div class="flex gap-2 text-sm">
            <button @click="triggerFileInput" class="bg-white hover:bg-slate-50 text-slate-600 px-4 py-2 rounded-lg border border-slate-200 shadow-sm transition flex items-center gap-2">
                ğŸ“‚ åŒ¯å…¥
            </button>
            <input type="file" ref="fileInput" class="hidden" @change="importData" accept=".json">
            
            <button @click="exportData" class="bg-white hover:bg-slate-50 text-slate-600 px-4 py-2 rounded-lg border border-slate-200 shadow-sm transition flex items-center gap-2">
                ğŸ’¾ å‚™ä»½
            </button>
            <button @click="clearAll" class="bg-white hover:bg-red-50 text-slate-600 hover:text-red-500 px-4 py-2 rounded-lg border border-slate-200 shadow-sm transition">
                ğŸ—‘ï¸ æ¸…é™¤
            </button>
        </div>
    </header>

    <!-- Dashboard Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <!-- Revenue Card -->
        <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-2xl p-6 text-white shadow-lg shadow-indigo-200 relative overflow-hidden">
            <div class="relative z-10">
                <div class="text-indigo-100 text-sm font-medium mb-1">ç¸½ç‡Ÿæ¥­é¡ (å ±åƒ¹ç¸½è¨ˆ)</div>
                <div class="text-3xl font-bold tracking-tight">{{ formatCurrency(totalRevenue) }}</div>
            </div>
            <div class="absolute right-4 bottom-4 opacity-20 transform scale-150">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </div>
        </div>

        <!-- Profit Card -->
        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-6 text-white shadow-lg shadow-emerald-200 relative overflow-hidden">
            <div class="relative z-10">
                <div class="text-emerald-100 text-sm font-medium mb-1">æ·¨åˆ©æ½¤ (å·²æ‰£é‹è²»)</div>
                <div class="text-3xl font-bold tracking-tight">{{ formatCurrency(totalProfit) }}</div>
            </div>
            <div class="absolute right-4 bottom-4 opacity-20 transform scale-150">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
            </div>
        </div>

        <!-- Orders Card -->
        <div class="bg-gradient-to-br from-orange-400 to-orange-500 rounded-2xl p-6 text-white shadow-lg shadow-orange-200 relative overflow-hidden">
            <div class="relative z-10">
                <div class="text-orange-100 text-sm font-medium mb-1">ç¸½è¨‚å–®æ•¸</div>
                <div class="text-3xl font-bold tracking-tight">{{ items.length }} <span class="text-lg font-normal opacity-80">ç­†</span></div>
            </div>
            <div class="absolute right-4 bottom-4 opacity-20 transform scale-150">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></svg>
            </div>
        </div>

        <!-- Unpaid Card -->
        <div class="bg-gradient-to-br from-rose-500 to-rose-600 rounded-2xl p-6 text-white shadow-lg shadow-rose-200 relative overflow-hidden">
            <div class="relative z-10">
                <div class="text-rose-100 text-sm font-medium mb-1">æœªç¹³æ¸…æ¬¾é …</div>
                <div class="text-3xl font-bold tracking-tight">{{ unpaidCount }} <span class="text-lg font-normal opacity-80">ç­†</span></div>
            </div>
            <div class="absolute right-4 bottom-4 opacity-20 transform scale-150">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="glass-panel p-6 bg-white">
            <h3 class="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                <span class="w-1 h-6 bg-indigo-500 rounded-full"></span> å“ç‰ŒéŠ·å”®ä½”æ¯” (Top 5 + å…¶ä»–)
            </h3>
            <div class="relative h-64">
                <canvas id="brandChart"></canvas>
            </div>
        </div>
        <div class="glass-panel p-6 bg-white">
            <h3 class="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                <span class="w-1 h-6 bg-indigo-500 rounded-full"></span> æœˆåº¦éŠ·å”®åˆ©æ½¤è¶¨å‹¢
            </h3>
            <div class="relative h-64">
                <canvas id="salesChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Rankings Section -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <!-- Best Selling Brands -->
        <div class="glass-panel p-6 bg-white">
            <h3 class="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                <span class="w-1 h-6 bg-orange-400 rounded-full"></span> ç†±éŠ·å“ç‰Œæ’è¡Œæ¦œ (Top 5)
            </h3>
            <div class="overflow-y-auto max-h-60">
                <table class="w-full text-sm">
                    <thead class="text-xs text-slate-400 bg-slate-50 uppercase sticky top-0">
                        <tr>
                            <th class="px-3 py-2 text-left">æ’å</th>
                            <th class="px-3 py-2 text-left">å“ç‰Œåç¨±</th>
                            <th class="px-3 py-2 text-right">éŠ·å”®æ•¸é‡</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(brand, idx) in topSellingBrands" :key="idx" class="border-b border-slate-50 last:border-0 hover:bg-slate-50">
                            <td class="px-3 py-3 w-12">
                                <span :class="getRankClass(idx)" class="flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold">
                                    {{ idx + 1 }}
                                </span>
                            </td>
                            <td class="px-3 py-3">
                                <div class="font-bold text-slate-700">{{ brand.name }}</div>
                            </td>
                            <td class="px-3 py-3 text-right font-bold text-slate-600">
                                {{ brand.count }} <span class="text-[10px] font-normal text-slate-400">ä»¶</span>
                            </td>
                        </tr>
                        <tr v-if="topSellingBrands.length === 0"><td colspan="3" class="text-center py-4 text-gray-400">å°šç„¡è³‡æ–™</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Highest Profit Products (Items) -->
        <div class="glass-panel p-6 bg-white">
            <h3 class="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                <span class="w-1 h-6 bg-emerald-500 rounded-full"></span> åˆ©æ½¤ç‹ (å–®å“ Top 5)
            </h3>
            <div class="overflow-y-auto max-h-60">
                <table class="w-full text-sm">
                    <thead class="text-xs text-slate-400 bg-slate-50 uppercase sticky top-0">
                        <tr>
                            <th class="px-3 py-2 text-left">æ’å</th>
                            <th class="px-3 py-2 text-left">å“å</th>
                            <th class="px-3 py-2 text-right">ç¸½åˆ©æ½¤</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(prod, idx) in topProfitProducts" :key="idx" class="border-b border-slate-50 last:border-0 hover:bg-slate-50">
                            <td class="px-3 py-3 w-12">
                                <span :class="getRankClass(idx)" class="flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold">
                                    {{ idx + 1 }}
                                </span>
                            </td>
                            <td class="px-3 py-3">
                                <div class="font-bold text-slate-700">{{ prod.name }}</div>
                                <div class="text-xs text-slate-400">{{ prod.brand }}</div>
                            </td>
                            <td class="px-3 py-3 text-right font-bold text-emerald-600 font-mono">
                                {{ formatCurrency(prod.totalProfit) }}
                            </td>
                        </tr>
                        <tr v-if="topProfitProducts.length === 0"><td colspan="3" class="text-center py-4 text-gray-400">å°šç„¡è³‡æ–™</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Input Form -->
    <div class="glass-panel p-6 mb-8 bg-white">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b border-slate-100 pb-4 gap-4">
            <h2 class="text-xl font-bold text-indigo-700 flex items-center gap-2">
                <span class="text-2xl">ğŸ“</span> æ–°å¢è¨‚å–®
            </h2>
            
            <!-- Currency Selection Area -->
            <div class="flex items-center gap-2 bg-slate-50 p-1.5 rounded-lg border border-slate-200">
                <label class="text-xs font-bold text-slate-500 ml-2">å¹£åˆ¥:</label>
                <select v-model="newItem.currency" class="bg-white border border-slate-200 text-slate-700 text-sm rounded-md focus:ring-indigo-500 focus:border-indigo-500 block p-1.5 outline-none font-bold">
                    <option v-for="c in currencyList" :value="c">{{ c }}</option>
                </select>
                <div class="flex items-center border-l border-slate-200 pl-2 gap-1">
                    <input type="text" v-model="newCurrencyInput" placeholder="è¼¸å…¥ä»£ç¢¼" class="w-20 text-sm p-1.5 rounded border border-slate-200 outline-none uppercase placeholder:normal-case">
                    <button @click="addCurrency" class="bg-indigo-100 text-indigo-600 hover:bg-indigo-200 p-1.5 rounded text-xs font-bold transition">æ–°å¢</button>
                </div>
            </div>

            <button @click="addItem" class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-2.5 rounded-full shadow-lg shadow-indigo-200 transform active:scale-95 transition font-bold text-sm w-full md:w-auto">
                ï¼‹ æ–°å¢è³‡æ–™
            </button>
        </div>
        
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-5">
            <!-- Basic Info -->
            <div class="col-span-1">
                <label class="text-xs font-bold text-slate-500 ml-1 mb-1 block">ä¸‹å–®æ—¥æœŸ</label>
                <input type="date" v-model="newItem.date" class="form-input w-full p-2.5 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-indigo-500 focus:outline-none text-sm">
            </div>
            <div class="col-span-1">
                <label class="text-xs font-bold text-slate-500 ml-1 mb-1 block">é¡§å®¢å§“å</label>
                <input type="text" v-model="newItem.customer" placeholder="è¼¸å…¥å§“å" class="form-input w-full p-2.5 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-indigo-500 focus:outline-none text-sm">
            </div>
            <div class="col-span-1">
                <label class="text-xs font-bold text-slate-500 ml-1 mb-1 block">å“ç‰Œ</label>
                <input type="text" v-model="newItem.brand" list="brandList" placeholder="é¸æ“‡æˆ–è¼¸å…¥" class="form-input w-full p-2.5 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-indigo-500 focus:outline-none text-sm">
                <datalist id="brandList">
                    <option v-for="b in uniqueBrands" :value="b"></option>
                </datalist>
            </div>
            <div class="col-span-1">
                <label class="text-xs font-bold text-slate-500 ml-1 mb-1 block">å“å</label>
                <input type="text" v-model="newItem.productName" placeholder="ç”¢å“åç¨±" class="form-input w-full p-2.5 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-indigo-500 focus:outline-none text-sm">
            </div>
            <div class="col-span-1">
                <label class="text-xs font-bold text-slate-500 ml-1 mb-1 block">å‹è™Ÿ</label>
                <input type="text" v-model="newItem.model" placeholder="ex: A-101" class="form-input w-full p-2.5 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-indigo-500 focus:outline-none text-sm">
            </div>
            <div class="col-span-1 flex items-end">
                <label class="flex items-center space-x-2 cursor-pointer bg-slate-100 px-4 rounded-xl w-full h-[42px] border border-transparent hover:border-indigo-200 transition">
                    <input type="checkbox" v-model="newItem.isPaid" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500">
                    <span class="text-sm font-medium text-slate-600">å·²ç¹³æ¸…æ¬¾é …</span>
                </label>
            </div>

            <!-- Price Info Foreign -->
            <div class="col-span-2 md:col-span-6 border-t border-slate-100 my-1"></div>

            <div class="col-span-1">
                <label class="text-xs font-bold text-slate-400 ml-1 mb-1 block">{{ newItem.currency }} åŸåƒ¹</label>
                <input type="number" v-model.number="newItem.priceJPY" :placeholder="getCurrencySymbol(newItem.currency)" class="form-input w-full p-2.5 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-slate-400 focus:outline-none text-sm">
            </div>
            <div class="col-span-1">
                <label class="text-xs font-bold text-orange-400 ml-1 mb-1 block">{{ newItem.currency }} æŠ˜å¾Œ</label>
                <input type="number" v-model.number="newItem.priceDiscountJPY" :placeholder="getCurrencySymbol(newItem.currency)" class="form-input w-full p-2.5 rounded-xl border border-orange-100 bg-orange-50 focus:bg-white focus:border-orange-500 focus:outline-none text-sm">
            </div>
            <div class="col-span-1">
                <label class="text-xs font-bold text-blue-400 ml-1 mb-1 block">{{ newItem.currency }} é€€ç¨…å¾Œ</label>
                <input type="number" v-model.number="newItem.priceTaxFreeJPY" :placeholder="getCurrencySymbol(newItem.currency)" class="form-input w-full p-2.5 rounded-xl border border-blue-100 bg-blue-50 focus:bg-white focus:border-blue-500 focus:outline-none text-sm">
            </div>
            
            <!-- Price Info TWD -->
            <div class="col-span-1">
                <label class="text-xs font-bold text-indigo-400 ml-1 mb-1 block">å°å¹£æˆæœ¬</label>
                <input type="number" v-model.number="newItem.priceTWD" @input="calculateProfit" class="form-input w-full p-2.5 rounded-xl border border-indigo-100 bg-indigo-50 focus:bg-white focus:border-indigo-500 focus:outline-none font-medium text-sm">
            </div>
            <div class="col-span-1">
                <label class="text-xs font-bold text-slate-500 ml-1 mb-1 block">é‹è²» (æˆæœ¬)</label>
                <input type="number" v-model.number="newItem.shipping" @input="calculateProfit" placeholder="æœƒæ‰£é™¤åˆ©æ½¤" class="form-input w-full p-2.5 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:border-indigo-500 focus:outline-none text-sm">
            </div>
            <div class="col-span-1">
                <label class="text-xs font-bold text-indigo-600 ml-1 mb-1 block">å ±åƒ¹ (ç¸½æ”¶å…¥)</label>
                <input type="number" v-model.number="newItem.quotePrice" @input="calculateProfit" class="form-input w-full p-2.5 rounded-xl border-2 border-indigo-100 bg-white focus:border-indigo-500 focus:outline-none font-bold text-indigo-700 text-sm">
            </div>
            <div class="col-span-2 md:col-span-6 flex justify-end mt-2">
                 <div class="bg-emerald-50 px-5 py-2 rounded-xl border border-emerald-100 flex items-center gap-3">
                    <span class="text-xs text-emerald-600 font-bold uppercase tracking-wider">é ä¼°åˆ©æ½¤</span>
                    <input type="number" v-model.number="newItem.profit" class="bg-transparent font-bold text-xl text-emerald-600 outline-none w-32 text-right" placeholder="0">
                 </div>
            </div>
        </div>
    </div>

    <!-- Data Table & Pagination -->
    <div class="glass-panel overflow-hidden bg-white mb-12">
        <div class="p-4 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-center gap-4 bg-slate-50">
            <!-- Items per page selector -->
            <div class="flex items-center gap-2">
                <span class="text-sm text-slate-500">é¡¯ç¤º</span>
                <select v-model="itemsPerPage" class="bg-white border border-slate-300 text-slate-700 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-1.5 outline-none font-medium">
                    <option :value="10">10</option>
                    <option :value="20">20</option>
                    <option :value="50">50</option>
                </select>
                <span class="text-sm text-slate-500">ç­† / é </span>
            </div>
            <!-- Pagination Info & Buttons -->
            <div class="flex items-center gap-2">
                <button @click="currentPage--" :disabled="currentPage === 1" class="px-3 py-1 bg-white border border-slate-300 rounded hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed text-sm">
                    ä¸Šä¸€é 
                </button>
                <span class="text-sm font-medium text-slate-600 min-w-[60px] text-center">
                    {{ currentPage }} / {{ totalPages || 1 }}
                </span>
                <button @click="currentPage++" :disabled="currentPage >= totalPages" class="px-3 py-1 bg-white border border-slate-300 rounded hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed text-sm">
                    ä¸‹ä¸€é 
                </button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-slate-500">
                <thead class="text-xs text-slate-700 uppercase bg-slate-50 border-b border-slate-100">
                    <tr>
                        <th class="px-4 py-4 font-bold">æ—¥æœŸ</th>
                        <th class="px-4 py-4 font-bold">å“ç‰Œ / å“å</th>
                        <th class="px-4 py-4 font-bold">é¡§å®¢</th>
                        <th class="px-4 py-4 w-36 font-bold">å¤–å¹£æ˜ç´°</th>
                        <th class="px-4 py-4 font-bold">å°å¹£æˆæœ¬</th>
                        <th class="px-4 py-4 font-bold">é‹è²»(æ‰£åˆ©æ½¤)</th>
                        <th class="px-4 py-4 font-bold">å ±åƒ¹</th>
                        <th class="px-4 py-4 font-bold">åˆ©æ½¤</th>
                        <th class="px-4 py-4 text-center font-bold">ç‹€æ…‹</th>
                        <th class="px-4 py-4 text-center font-bold">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                    <tr v-for="(item, idx) in paginatedItems" :key="idx" class="hover:bg-slate-50 transition duration-150">
                        <td class="px-4 py-3 whitespace-nowrap font-mono text-xs text-slate-400">{{ item.date }}</td>
                        <td class="px-4 py-3">
                            <div class="font-bold text-slate-700">{{ item.brand }}</div>
                            <div class="text-xs text-slate-500">{{ item.productName }} <span v-if="item.model" class="text-slate-400">({{ item.model }})</span></div>
                        </td>
                        <td class="px-4 py-3 text-slate-600">{{ item.customer }}</td>
                        <td class="px-4 py-3">
                            <div class="flex flex-col gap-1 items-start">
                                <span v-if="item.priceJPY" class="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full whitespace-nowrap">
                                    åŸ {{ getCurrencySymbol(item.currency) }}{{ item.priceJPY }}
                                </span>
                                <span v-if="item.priceDiscountJPY" class="text-[10px] bg-orange-50 text-orange-600 font-bold px-2 py-0.5 rounded-full whitespace-nowrap border border-orange-100">
                                    æŠ˜ {{ getCurrencySymbol(item.currency) }}{{ item.priceDiscountJPY }}
                                </span>
                                <span v-if="item.priceTaxFreeJPY" class="text-[10px] bg-blue-50 text-blue-600 font-bold px-2 py-0.5 rounded-full whitespace-nowrap border border-blue-100">
                                    é€€ {{ getCurrencySymbol(item.currency) }}{{ item.priceTaxFreeJPY }}
                                </span>
                                <span v-if="!item.priceJPY && !item.priceDiscountJPY && !item.priceTaxFreeJPY" class="text-slate-200 text-xs">-</span>
                            </div>
                        </td>
                        <td class="px-4 py-3 font-mono text-slate-600">{{ formatCurrency(item.priceTWD) }}</td>
                        <td class="px-4 py-3 font-mono text-slate-400">{{ item.shipping ? formatCurrency(item.shipping) : '-' }}</td>
                        <td class="px-4 py-3 font-mono font-bold text-indigo-600">{{ formatCurrency(item.quotePrice) }}</td>
                        <td class="px-4 py-3 font-mono font-bold text-emerald-600">+{{ formatCurrency(item.profit) }}</td>
                        <td class="px-4 py-3 text-center whitespace-nowrap">
                            <span @click="togglePaid(getItemRealIndex(idx))" :class="item.isPaid ? 'bg-emerald-100 text-emerald-700 ring-1 ring-emerald-200' : 'bg-rose-100 text-rose-700 ring-1 ring-rose-200'" class="cursor-pointer px-3 py-1 rounded-full text-xs font-bold select-none transition hover:opacity-80">
                                {{ item.isPaid ? 'å·²ç¹³æ¸…' : 'æœªç¹³' }}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <button @click="deleteItem(getItemRealIndex(idx))" class="w-8 h-8 rounded-full hover:bg-rose-50 text-slate-300 hover:text-rose-500 transition flex items-center justify-center">âœ•</button>
                        </td>
                    </tr>
                    <tr v-if="items.length === 0">
                        <td colspan="10" class="px-6 py-12 text-center text-slate-400">
                            <div class="text-4xl mb-2">ğŸ“‹</div>
                            ç›®å‰æ²’æœ‰è¨‚å–®è³‡æ–™ï¼Œè«‹åœ¨ä¸Šæ–¹æ–°å¢
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, watch, onMounted } = Vue;

    createApp({
        setup() {
            const defaultItem = {
                brand: '', customer: '', productName: '', model: '',
                isPaid: false, date: new Date().toISOString().split('T')[0],
                currency: 'JPY', 
                priceJPY: '', priceDiscountJPY: '', priceTaxFreeJPY: '',
                priceTWD: '', quotePrice: '', shipping: '', profit: ''
            };

            const newItem = ref({ ...defaultItem });
            const items = ref([]);
            
            // Pagination State
            const currentPage = ref(1);
            const itemsPerPage = ref(10);
            
            // Currency Management
            const currencyList = ref(['JPY', 'THB']); 
            const newCurrencyInput = ref('');

            // Chart instances
            let brandChartInstance = null;
            let salesChartInstance = null;

            onMounted(() => {
                const savedData = localStorage.getItem('daigou_data');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    items.value = parsed.map(i => ({...i, currency: i.currency || 'JPY'}));
                }
                const savedCurrencies = localStorage.getItem('daigou_currencies');
                if (savedCurrencies) {
                    currencyList.value = JSON.parse(savedCurrencies);
                }
                renderCharts();
            });

            // Watchers
            watch(items, (newVal) => {
                localStorage.setItem('daigou_data', JSON.stringify(newVal));
                updateCharts();
                // å¦‚æœåˆªé™¤è³‡æ–™å°è‡´ç•¶å‰é ç¢¼ç©ºç™½ï¼Œè‡ªå‹•è·³å›ä¸Šä¸€é 
                if (currentPage.value > totalPages.value && totalPages.value > 0) {
                    currentPage.value = totalPages.value;
                }
            }, { deep: true });

            watch(currencyList, (newVal) => {
                localStorage.setItem('daigou_currencies', JSON.stringify(newVal));
            }, { deep: true });

            // æ›é æ•¸æˆ–æ–°å¢è³‡æ–™æ™‚é‡ç½®é ç¢¼
            watch(itemsPerPage, () => currentPage.value = 1);

            // Pagination Logic
            const totalPages = computed(() => Math.ceil(items.value.length / itemsPerPage.value));
            
            const paginatedItems = computed(() => {
                const start = (currentPage.value - 1) * itemsPerPage.value;
                const end = start + itemsPerPage.value;
                return items.value.slice(start, end);
            });

            // å–å¾—å¯¦éš› Index (å› ç‚ºåˆ†é å¾Œ idx æ˜¯ 0-9ï¼Œéœ€æ›ç®—å› items çš„ index)
            const getItemRealIndex = (pageIndex) => {
                return (currentPage.value - 1) * itemsPerPage.value + pageIndex;
            };

            // Helper Functions
            const addCurrency = () => {
                const code = newCurrencyInput.value.trim().toUpperCase();
                if (code && !currencyList.value.includes(code)) {
                    currencyList.value.push(code);
                    newItem.value.currency = code; 
                    newCurrencyInput.value = '';
                } else if(currencyList.value.includes(code)){
                    alert('å¹£åˆ¥å·²å­˜åœ¨');
                }
            };

            const getCurrencySymbol = (code) => {
                const map = { 'JPY': 'Â¥', 'THB': 'à¸¿', 'USD': '$', 'EUR': 'â‚¬', 'KRW': 'â‚©', 'TWD': 'NT$' };
                return map[code] || code;
            };

            const normalizeBrand = (brand) => {
                if (!brand) return 'å…¶ä»–';
                return brand.trim().toUpperCase();
            };

            const calculateProfit = () => {
                const quote = parseFloat(newItem.value.quotePrice) || 0;
                const cost = parseFloat(newItem.value.priceTWD) || 0;
                const shipping = parseFloat(newItem.value.shipping) || 0;
                if (quote > 0) {
                    newItem.value.profit = quote - cost - shipping;
                }
            };

            const addItem = () => {
                if (!newItem.value.productName || !newItem.value.quotePrice) {
                    alert('è«‹è‡³å°‘è¼¸å…¥ã€Œå“åã€èˆ‡ã€Œå ±åƒ¹ã€');
                    return;
                }
                items.value.unshift({ ...newItem.value });
                const currentDate = newItem.value.date;
                const currentCurrency = newItem.value.currency; 
                newItem.value = { ...defaultItem, date: currentDate, currency: currentCurrency };
                currentPage.value = 1; // å›åˆ°ç¬¬ä¸€é çœ‹æ–°è³‡æ–™
            };

            const deleteItem = (realIndex) => {
                if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿ')) {
                    items.value.splice(realIndex, 1);
                }
            };

            const togglePaid = (realIndex) => {
                items.value[realIndex].isPaid = !items.value[realIndex].isPaid;
            };

            const clearAll = () => {
                if(confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                    items.value = [];
                    currentPage.value = 1;
                }
            };

            const exportData = () => {
                const dataStr = JSON.stringify(items.value);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = 'ä»£è³¼è³‡æ–™å‚™ä»½_'+new Date().toISOString().slice(0,10)+'.json';
                let linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            };

            const fileInput = ref(null);
            const triggerFileInput = () => { fileInput.value.click(); };

            const importData = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (Array.isArray(imported)) {
                            if(confirm('åŒ¯å…¥å°‡æœƒè¦†è“‹ç›®å‰çš„è³‡æ–™ï¼Œç¢ºå®šå—ï¼Ÿ(è‹¥æƒ³åˆä½µè«‹é¸å–æ¶ˆ)')) {
                                items.value = imported.map(i => ({...i, currency: i.currency || 'JPY'}));
                            } else {
                                const processed = imported.map(i => ({...i, currency: i.currency || 'JPY'}));
                                items.value = [...items.value, ...processed];
                            }
                            currentPage.value = 1;
                        } else { alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤'); }
                    } catch (err) { alert('ç„¡æ³•è®€å–æª”æ¡ˆ'); }
                };
                reader.readAsText(file);
                event.target.value = ''; 
            };

            // Stats
            const totalRevenue = computed(() => items.value.reduce((sum, item) => sum + (parseFloat(item.quotePrice) || 0), 0));
            const totalProfit = computed(() => items.value.reduce((sum, item) => sum + (parseFloat(item.profit) || 0), 0));
            const unpaidCount = computed(() => items.value.filter(item => !item.isPaid).length);
            
            const uniqueBrands = computed(() => {
                const brandSet = new Set();
                items.value.forEach(item => {
                    if(item.brand) brandSet.add(normalizeBrand(item.brand));
                });
                return [...brandSet];
            });

            // Rankings
            const topSellingBrands = computed(() => {
                const stats = {};
                items.value.forEach(item => {
                    const b = normalizeBrand(item.brand);
                    if (!stats[b]) { stats[b] = { name: b, count: 0 }; }
                    stats[b].count += 1;
                });
                return Object.values(stats).sort((a, b) => b.count - a.count).slice(0, 5);
            });

            const topProfitProducts = computed(() => {
                const stats = {};
                items.value.forEach(item => {
                    const b = normalizeBrand(item.brand);
                    const key = b + ' - ' + item.productName;
                    if (!stats[key]) { stats[key] = { name: item.productName, brand: b, totalProfit: 0 }; }
                    stats[key].totalProfit += (parseFloat(item.profit) || 0);
                });
                return Object.values(stats).sort((a, b) => b.totalProfit - a.totalProfit).slice(0, 5);
            });

            const getRankClass = (idx) => {
                if (idx === 0) return 'rank-1';
                if (idx === 1) return 'rank-2';
                if (idx === 2) return 'rank-3';
                return 'rank-other';
            };

            const formatCurrency = (val) => {
                if (!val && val !== 0) return '-';
                return new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(val);
            };

            // Charts
            const renderCharts = () => {
                const ctxBrand = document.getElementById('brandChart');
                const ctxSales = document.getElementById('salesChart');
                if (!ctxBrand || !ctxSales) return;

                brandChartInstance = new Chart(ctxBrand, {
                    type: 'doughnut',
                    data: { labels: [], datasets: [] },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'right' } } }
                });

                salesChartInstance = new Chart(ctxSales, {
                    type: 'bar',
                    data: { labels: [], datasets: [] },
                    options: { 
                        responsive: true, maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, grid: { color: '#f1f5f9' } }, x: { grid: { display: false } } },
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
                updateCharts();
            };

            const updateCharts = () => {
                if (!brandChartInstance || !salesChartInstance) return;

                // 1. å“ç‰Œæ•¸æ“š (å„ªåŒ–ï¼šå– Top 5 + Others)
                const brandCounts = {};
                items.value.forEach(i => {
                    const b = normalizeBrand(i.brand);
                    brandCounts[b] = (brandCounts[b] || 0) + 1;
                });
                
                // æ’åºä¸¦è™•ç† Top 5
                const sortedBrands = Object.entries(brandCounts).sort((a, b) => b[1] - a[1]);
                let finalLabels = [];
                let finalData = [];
                
                if (sortedBrands.length > 5) {
                    const top5 = sortedBrands.slice(0, 5);
                    const others = sortedBrands.slice(5);
                    const othersSum = others.reduce((sum, item) => sum + item[1], 0);
                    
                    finalLabels = top5.map(i => i[0]);
                    finalData = top5.map(i => i[1]);
                    
                    finalLabels.push('å…¶ä»– (Others)');
                    finalData.push(othersSum);
                } else {
                    finalLabels = sortedBrands.map(i => i[0]);
                    finalData = sortedBrands.map(i => i[1]);
                }
                
                brandChartInstance.data = {
                    labels: finalLabels,
                    datasets: [{
                        data: finalData,
                        backgroundColor: ['#6366f1', '#ec4899', '#10b981', '#f59e0b', '#8b5cf6', '#94a3b8'], // æœ€å¾Œä¸€å€‹ç°è‰²çµ¦ Others
                        borderWidth: 0
                    }]
                };
                brandChartInstance.update();

                // 2. æœˆåº¦æ•¸æ“š
                const monthlyData = {};
                items.value.forEach(i => {
                    if (!i.date) return;
                    const month = i.date.substring(0, 7); 
                    if (!monthlyData[month]) monthlyData[month] = { sales: 0, profit: 0 };
                    monthlyData[month].sales += (parseFloat(i.quotePrice) || 0);
                    monthlyData[month].profit += (parseFloat(i.profit) || 0);
                });

                const sortedMonths = Object.keys(monthlyData).sort();
                
                salesChartInstance.data = {
                    labels: sortedMonths,
                    datasets: [
                        { label: 'ç‡Ÿæ¥­é¡', data: sortedMonths.map(m => monthlyData[m].sales), backgroundColor: '#c7d2fe', borderRadius: 4 },
                        { label: 'æ·¨åˆ©æ½¤', data: sortedMonths.map(m => monthlyData[m].profit), backgroundColor: '#6366f1', borderRadius: 4 }
                    ]
                };
                salesChartInstance.update();
            };

            return {
                newItem, items, addItem, deleteItem, togglePaid, clearAll,
                totalRevenue, totalProfit, unpaidCount, uniqueBrands,
                formatCurrency, calculateProfit,
                exportData, importData, triggerFileInput, fileInput,
                topSellingBrands, topProfitProducts, getRankClass,
                currencyList, newCurrencyInput, addCurrency, getCurrencySymbol,
                // Pagination
                currentPage, itemsPerPage, totalPages, paginatedItems, getItemRealIndex
            };
        }
    }).mount('#app');
</script>

</body>
</html>