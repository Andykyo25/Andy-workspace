<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>業務出團表紀錄系統</title>
    <!-- 引入 Bootstrap 5 做美化 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入 FontAwesome 做圖示 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding: 20px; font-family: "Microsoft JhengHei", sans-serif; }
        .table-container { overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 15px; }
        th { white-space: nowrap; background-color: #2c3e50 !important; color: white; vertical-align: middle; }
        td { white-space: nowrap; vertical-align: middle; }
        .btn-group-action { display: flex; gap: 5px; }
        .status-v { color: green; font-weight: bold; }
        .form-label { font-weight: bold; font-size: 0.9rem; }
        /* 針對特定欄位設定最小寬度 */
        .min-w-100 { min-width: 100px; }
    </style>
</head>
<body>

<div class="container-fluid">
    <h2 class="mb-4 text-center"><i class="fas fa-plane-departure"></i> 業務出團表紀錄</h2>

    <!-- 操作區塊 -->
    <div class="row mb-3">
        <div class="col-md-12 text-end">
            <button class="btn btn-success" onclick="exportToCSV()"><i class="fas fa-file-excel"></i> 匯出 Excel (CSV)</button>
            <label class="btn btn-warning btn-file">
                <i class="fas fa-file-upload"></i> 匯入 CSV <input type="file" id="csvFileInput" style="display: none;" onchange="importFromCSV(this)">
            </label>
            <button class="btn btn-danger" onclick="clearAllData()"><i class="fas fa-trash"></i> 清空所有資料</button>
        </div>
    </div>

    <!-- 輸入表單 (使用摺疊面板收納) -->
    <div class="accordion mb-4" id="accordionForm">
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingOne">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true">
                    <strong><i class="fas fa-plus-circle"></i> 新增 / 編輯 資料</strong>
                </button>
            </h2>
            <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#accordionForm">
                <div class="accordion-body">
                    <form id="recordForm" onsubmit="event.preventDefault(); saveRecord();">
                        <input type="hidden" id="editIndex" value="-1">
                        <div class="row g-2">
                            <div class="col-md-2"><label class="form-label">出發日期</label><input type="date" class="form-control" id="f_date" required></div>
                            <div class="col-md-3"><label class="form-label">行程</label><input type="text" class="form-control" id="f_tour" placeholder="例如: 芬蘭破冰船15日" required></div>
                            <div class="col-md-2"><label class="form-label">客人代表</label><input type="text" class="form-control" id="f_name" required></div>
                            <div class="col-md-2"><label class="form-label">電話號碼</label><input type="text" class="form-control" id="f_phone"></div>
                            <div class="col-md-1"><label class="form-label">人數</label><input type="number" class="form-control" id="f_pax" min="1"></div>
                            <div class="col-md-2"><label class="form-label">訂編</label><input type="text" class="form-control" id="f_bookingId"></div>
                            
                            <div class="col-md-2"><label class="form-label">預估業績</label><input type="number" class="form-control" id="f_estRev"></div>
                            <div class="col-md-2"><label class="form-label">實際業績</label><input type="number" class="form-control" id="f_actRev"></div>
                            <div class="col-md-2"><label class="form-label">合約狀態</label>
                                <select class="form-select" id="f_contract">
                                    <option value="">未簽約</option>
                                    <option value="線上">線上</option>
                                    <option value="紙本">紙本</option>
                                </select>
                            </div>
                            <!-- 新增欄位：寄出紙本 -->
                            <div class="col-md-2"><label class="form-label" style="color:#d63384">寄出紙本</label>
                                <select class="form-select" id="f_paperSent">
                                    <option value="">否</option>
                                    <option value="V">是 (V)</option>
                                </select>
                            </div>
                            
                            <div class="col-md-2"><label class="form-label">訂金</label><input type="number" class="form-control" id="f_deposit"></div>
                            <div class="col-md-2"><label class="form-label">尾款</label><input type="number" class="form-control" id="f_balance"></div>
                            <!-- 新增欄位：繳帳單寄出 -->
                            <div class="col-md-2"><label class="form-label" style="color:#d63384">繳帳單寄出</label>
                                <select class="form-select" id="f_billSent">
                                    <option value="">否</option>
                                    <option value="V">是 (V)</option>
                                </select>
                            </div>

                            <div class="col-md-1"><label class="form-label">名單</label><select class="form-select" id="f_list"><option value="">-</option><option value="V">V</option></select></div>
                            <div class="col-md-1"><label class="form-label">分房</label><select class="form-select" id="f_room"><option value="">-</option><option value="V">V</option></select></div>
                            <div class="col-md-1"><label class="form-label">確認1</label><select class="form-select" id="f_cf1"><option value="">-</option><option value="V">V</option></select></div>
                            <div class="col-md-1"><label class="form-label">確認2</label><select class="form-select" id="f_cf2"><option value="">-</option><option value="V">V</option></select></div>
                        </div>
                        <div class="mt-3 text-center">
                            <button type="submit" class="btn btn-primary w-25">儲存紀錄</button>
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">重置表單</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 表格顯示區 -->
    <div class="table-container">
        <table class="table table-hover table-bordered table-striped" id="dataTable">
            <thead>
                <tr>
                    <th>操作</th>
                    <th>出發日期</th>
                    <th>行程</th>
                    <th>客人代表</th>
                    <th>電話號碼</th>
                    <th>人數</th>
                    <th>預估業績</th>
                    <th>實際業績</th>
                    <th>訂編</th>
                    <th>合約</th>
                    <th style="background-color: #6610f2;">寄出紙本</th> <!-- 新增 -->
                    <th>訂金</th>
                    <th>尾款</th>
                    <th style="background-color: #6610f2;">繳帳單寄出</th> <!-- 新增 -->
                    <th>名單</th>
                    <th>分房</th>
                    <th>確認1</th>
                    <th>確認2</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- 資料會由 JS 插入 -->
            </tbody>
        </table>
    </div>
</div>

<script>
    // 定義欄位名稱 (對應 CSV Header)
    const headers = [
        "出發日期", "行程", "客人代表", "電話號碼", "人數", 
        "預估業績", "實際業績", "訂編", "合約", "寄出紙本", 
        "訂金", "尾款", "繳帳單寄出", "名單", "分房", "確認1", "確認2"
    ];

    // 初始化資料
    let salesData = JSON.parse(localStorage.getItem('salesGroupData')) || [];

    // 頁面載入時渲染表格
    window.onload = function() {
        renderTable();
    };

    // 渲染表格
    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        salesData.forEach((row, index) => {
            let tr = document.createElement('tr');
            
            // 操作按鈕
            let btnTd = `
                <td>
                    <div class="btn-group-action">
                        <button class="btn btn-sm btn-primary" onclick="editData(${index})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteData(${index})"><i class="fas fa-trash"></i></button>
                    </div>
                </td>`;
            
            // 產生資料欄位
            let dataTd = `
                <td>${row.date}</td>
                <td>${row.tour}</td>
                <td>${row.name}</td>
                <td>${row.phone}</td>
                <td>${row.pax}</td>
                <td>${formatMoney(row.estRev)}</td>
                <td>${formatMoney(row.actRev)}</td>
                <td>${row.bookingId}</td>
                <td>${row.contract}</td>
                <td class="${row.paperSent === 'V' ? 'status-v' : ''}">${row.paperSent || ''}</td>
                <td>${formatMoney(row.deposit)}</td>
                <td>${formatMoney(row.balance)}</td>
                <td class="${row.billSent === 'V' ? 'status-v' : ''}">${row.billSent || ''}</td>
                <td class="${row.list === 'V' ? 'status-v' : ''}">${row.list}</td>
                <td class="${row.room === 'V' ? 'status-v' : ''}">${row.room}</td>
                <td class="${row.cf1 === 'V' ? 'status-v' : ''}">${row.cf1}</td>
                <td class="${row.cf2 === 'V' ? 'status-v' : ''}">${row.cf2}</td>
            `;

            tr.innerHTML = btnTd + dataTd;
            tbody.appendChild(tr);
        });
    }

    // 格式化金錢 (加逗號)
    function formatMoney(num) {
        if (!num) return '';
        return parseInt(num).toLocaleString();
    }

    // 儲存資料 (新增或編輯)
    function saveRecord() {
        const data = {
            date: document.getElementById('f_date').value,
            tour: document.getElementById('f_tour').value,
            name: document.getElementById('f_name').value,
            phone: document.getElementById('f_phone').value,
            pax: document.getElementById('f_pax').value,
            estRev: document.getElementById('f_estRev').value,
            actRev: document.getElementById('f_actRev').value,
            bookingId: document.getElementById('f_bookingId').value,
            contract: document.getElementById('f_contract').value,
            paperSent: document.getElementById('f_paperSent').value, // 新增
            deposit: document.getElementById('f_deposit').value,
            balance: document.getElementById('f_balance').value,
            billSent: document.getElementById('f_billSent').value, // 新增
            list: document.getElementById('f_list').value,
            room: document.getElementById('f_room').value,
            cf1: document.getElementById('f_cf1').value,
            cf2: document.getElementById('f_cf2').value
        };

        const editIndex = document.getElementById('editIndex').value;

        if (editIndex === "-1") {
            // 新增
            salesData.push(data);
        } else {
            // 編輯
            salesData[editIndex] = data;
            document.getElementById('editIndex').value = "-1";
            // 切換按鈕樣式
            document.querySelector('#recordForm button[type="submit"]').textContent = "儲存紀錄";
            document.querySelector('#recordForm button[type="submit"]').classList.remove('btn-warning');
            document.querySelector('#recordForm button[type="submit"]').classList.add('btn-primary');
        }

        saveToLocal();
        renderTable();
        resetForm();
    }

    // 編輯資料
    function editData(index) {
        const row = salesData[index];
        document.getElementById('f_date').value = row.date;
        document.getElementById('f_tour').value = row.tour;
        document.getElementById('f_name').value = row.name;
        document.getElementById('f_phone').value = row.phone;
        document.getElementById('f_pax').value = row.pax;
        document.getElementById('f_bookingId').value = row.bookingId;
        document.getElementById('f_estRev').value = row.estRev;
        document.getElementById('f_actRev').value = row.actRev;
        document.getElementById('f_contract').value = row.contract;
        document.getElementById('f_paperSent').value = row.paperSent; // 新增
        document.getElementById('f_deposit').value = row.deposit;
        document.getElementById('f_balance').value = row.balance;
        document.getElementById('f_billSent').value = row.billSent; // 新增
        document.getElementById('f_list').value = row.list;
        document.getElementById('f_room').value = row.room;
        document.getElementById('f_cf1').value = row.cf1;
        document.getElementById('f_cf2').value = row.cf2;

        document.getElementById('editIndex').value = index;
        
        // 展開表單
        new bootstrap.Collapse(document.getElementById('collapseOne'), { show: true });
        
        // 變更按鈕提示
        const submitBtn = document.querySelector('#recordForm button[type="submit"]');
        submitBtn.textContent = "更新資料";
        submitBtn.classList.remove('btn-primary');
        submitBtn.classList.add('btn-warning');
        
        window.scrollTo(0, 0);
    }

    // 刪除資料
    function deleteData(index) {
        if(confirm('確定要刪除這筆資料嗎？')) {
            salesData.splice(index, 1);
            saveToLocal();
            renderTable();
        }
    }

    // 儲存到 LocalStorage
    function saveToLocal() {
        localStorage.setItem('salesGroupData', JSON.stringify(salesData));
    }

    // 重置表單
    function resetForm() {
        document.getElementById('recordForm').reset();
        document.getElementById('editIndex').value = "-1";
        const submitBtn = document.querySelector('#recordForm button[type="submit"]');
        submitBtn.textContent = "儲存紀錄";
        submitBtn.classList.remove('btn-warning');
        submitBtn.classList.add('btn-primary');
    }

    // 清空所有資料
    function clearAllData() {
        if(confirm('警告：這將會刪除所有資料且無法復原！建議先匯出備份。確定要清空嗎？')) {
            salesData = [];
            saveToLocal();
            renderTable();
        }
    }

    // 匯出 CSV
    function exportToCSV() {
        // 加入 BOM 讓 Excel 能正確識別 UTF-8 中文
        let csvContent = "\uFEFF"; 
        csvContent += headers.join(",") + "\n";

        salesData.forEach(row => {
            let rowArray = [
                row.date,
                `"${row.tour}"`, // 避免行程名稱中有逗號
                row.name,
                `'${row.phone}`, // 強制 Excel 顯示 0 開頭
                row.pax,
                row.estRev,
                row.actRev,
                row.bookingId,
                row.contract,
                row.paperSent, // 新增
                row.deposit,
                row.balance,
                row.billSent, // 新增
                row.list,
                row.room,
                row.cf1,
                row.cf2
            ];
            csvContent += rowArray.join(",") + "\n";
        });

        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        const now = new Date();
        const dateStr = `${now.getMonth()+1}_${now.getDate()}`;
        
        link.setAttribute("href", url);
        link.setAttribute("download", `業務出團表_${dateStr}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // 匯入 CSV
    function importFromCSV(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const rows = text.split("\n");
            
            // 跳過標題列，從第一行開始
            // 注意：這裡假設匯入的格式與匯出的格式完全一致
            let newData = [];
            for (let i = 1; i < rows.length; i++) {
                let cols = rows[i].split(",");
                if (cols.length < 5) continue; // 過濾空行

                // 清理 CSV 格式 (移除引號、移除電話的單引號)
                const clean = (str) => str ? str.replace(/^"|"$/g, '').replace(/^'/, '').trim() : '';

                let obj = {
                    date: clean(cols[0]),
                    tour: clean(cols[1]),
                    name: clean(cols[2]),
                    phone: clean(cols[3]),
                    pax: clean(cols[4]),
                    estRev: clean(cols[5]),
                    actRev: clean(cols[6]),
                    bookingId: clean(cols[7]),
                    contract: clean(cols[8]),
                    paperSent: clean(cols[9]), // 新增
                    deposit: clean(cols[10]),
                    balance: clean(cols[11]),
                    billSent: clean(cols[12]), // 新增
                    list: clean(cols[13]),
                    room: clean(cols[14]),
                    cf1: clean(cols[15]),
                    cf2: clean(cols[16])
                };
                newData.push(obj);
            }

            if(confirm(`解析到 ${newData.length} 筆資料，確定要覆蓋現有資料嗎？(若選擇取消則會保留現有資料並附加新資料)`)) {
                salesData = newData;
            } else {
                salesData = salesData.concat(newData);
            }
            saveToLocal();
            renderTable();
            // 清空 input 讓同一檔案可重複選取
            input.value = ''; 
        };
        reader.readAsText(file);
    }
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>